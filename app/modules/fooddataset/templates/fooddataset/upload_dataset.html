{% extends "base_template.html" %}

{% block title %}Upload Food Dataset{% endblock %}

{% block content %}

    <h1 class="h2 mb-3"><b>Upload</b> Food Dataset</h1>

    <div class="row">
        <div class="col-12 mb-3">
            <div class="alert alert-warning" role="alert" id="test_fakenodo_connection_error" style="display: none">
                <div class="alert-message">
                    <h4 class="alert-heading"><i class="align-middle" data-feather="alert-triangle"></i> Fakenodo Connection Issue</h4>
                    <p class="p-0 m-0">
                        There seems to be a problem with the Fakenodo API. We will save your files locally and synchronize later.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-xl-6 col-lg-12 col-md-12 col-sm-12">
            <div id="basic_info_form">
                {{ form.hidden_tag() }}
                {{ form.import_method(type="hidden", id="import_method") }}
                
                <div class="row">
                    <div class="col-12">
                        <h1 class="h3 mb-3">Basic info</h1>
                        <div class="row" style="padding-left: 2rem">
                            
                            <div class="col-12 mb-3">
                                {{ form.title.label(class="form-label") }} *
                                {{ form.title(class="form-control") }}
                            </div>

                            <div class="col-12 mb-3">
                                {{ form.desc.label(class="form-label") }} *
                                {{ form.desc(rows=4, class="form-control") }}
                            </div>

                            <div class="col-6 mb-3">
                                {{ form.publication_type.label(class="form-label") }}
                                {{ form.publication_type(class="form-control") }}
                            </div>

                            <div class="col-6 mb-3">
                                {{ form.publication_doi.label(class="form-label") }}
                                {{ form.publication_doi(class="form-control") }}
                            </div>

                            <div class="col-12 mb-3">
                                {{ form.tags.label(class="form-label") }}
                                {{ form.tags(class="form-control") }}
                            </div>
                        </div>

                        <h1 class="h3 mb-3 mt-4">Authors</h1>
                        <div class="row" style="padding-left: 2rem">
                            <div class="col-12 mb-3">
                                <label class="form-label">Main Author (You)</label>
                                <input class="form-control" disabled value="{{ current_user.profile.surname }}, {{ current_user.profile.name }}">
                            </div>
                            
                            <div class="col-12">
                                <div id="authors"></div>
                                <button type="button" class="btn btn-secondary mt-2" id="add_author">Add author</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-6 col-lg-12 col-md-12 col-sm-12">
            <h1 class="h3 mb-3 mt-2">Food Models (.food)</h1>

            <ul class="nav nav-tabs" id="uploadTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <a class="nav-link active" id="local-tab" data-bs-toggle="tab" href="#local_tab" role="tab" aria-controls="local_tab" aria-selected="true">Local file</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="github-tab" data-bs-toggle="tab" href="#github_tab" role="tab" aria-controls="github_tab" aria-selected="false">From GitHub repo</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="zip-tab" data-bs-toggle="tab" href="#zip_tab" role="tab" aria-controls="zip_tab" aria-selected="false">From ZIP</a>
            </li>
            </ul>
            
        <div class="tab-content mt-3">

            <!-- LOCAL FILE -->
            <div class="tab-pane fade show active"
                id="local_tab"
                role="tabpanel"
                aria-labelledby="local-tab">

                <div id="uploaded_models_form" style="padding-left: 2rem">

                    <form action="{{ url_for('fooddataset.upload_file_temp') }}"
                        class="dropzone"
                        id="myDropzone">
                        <div class="dz-message" data-dz-message>
                            <span>Drop .food files here to upload</span>
                        </div>
                    </form>

                    <span class="text-danger"
                        id="alerts"
                        style="display: none"></span>

                    <ul class="mt-2"
                        id="file-list"
                        style="list-style: none; padding: 0;">
                    </ul>

                </div>
            </div>

            <!-- GITHUB REPO -->
            <div class="tab-pane fade"
                id="github_tab"
                role="tabpanel"
                aria-labelledby="github-tab">

                {% include "fooddataset/_upload_github.html" %}

                <div id="gh_status"
                    class="mt-3"
                    style="display:none"></div>
            </div>

            <!-- ZIP -->
            <div class="tab-pane fade"
                id="zip_tab"
                role="tabpanel"
                aria-labelledby="zip-tab">

                {% include "fooddataset/_upload_zip.html" %}

            </div>

        </div>

        </div>
    </div>

    <div class="row" id="upload_dataset" style="display: none">
        <div class="col-12">
            <hr>
            <div style="padding-left: 2rem">
                <label class="form-check mb-3">
                    <input id="agreeCheckbox" class="form-check-input" type="checkbox">
                    <span class="form-check-label">
                        I agree to upload my food models to Fakenodo (Open Science).
                    </span>
                </label>

                <button id="upload_button" class="btn btn-primary" disabled>
                    <i data-feather="upload" class="me-1"></i> Upload Dataset
                </button>
                
                <div id="loading" style="display: none" class="mt-2">
                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                    Uploading dataset, please wait...
                </div>
                
                <div id="upload_error" class="text-danger mt-2" style="display: none"></div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12 text-end">
            <button id="save_as_draft_button" class="btn btn-outline-secondary">
                <i data-feather="save"></i>
                Save as draft
            </button>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" integrity="sha512-Ho8qGg5k9GkQmAl9fY2Gxg9rXkqM3nI/6s4k3q5uQ5r3a9Vxjz9u0YwK2N6m9RpXq2zGx9X0cG9Kz7TgGk4h2Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script>

            let incrementalIdCounter = 0;
            function generateIncrementalId() {
                return incrementalIdCounter++;
            }
            
        function addFoodModelElement(filename) {
            show_upload_dataset(); 

            let formUniqueId = generateIncrementalId(); 
            let fileList = document.getElementById('file-list'); 

            function findFileListContainer() {
                const activePane = document.querySelector('.tab-pane.show.active');
                if (activePane) {
                    const fl = activePane.querySelector('#file-list') || activePane.querySelector('#file-list-gh') || activePane.querySelector('#file-list-zip');
                    if (fl) return fl;
                }
                return document.getElementById('file-list') || document.getElementById('file-list-gh') || document.getElementById('file-list-zip');
            }

            fileList = findFileListContainer();


            let listItem = document.createElement('li');
            listItem.className = "mb-3 p-3 border rounded bg-light";
            
            let header = document.createElement('div');
            header.className = "d-flex justify-content-between align-items-center mb-2";
            
            let leftContainer = document.createElement('div');
            leftContainer.className = "d-flex align-items-center";
            
            let title = document.createElement('strong');
            title.textContent = filename;
            
            let statusSpan = document.createElement('span');
            statusSpan.id = `check_status_${formUniqueId}`;
            statusSpan.className = "ms-3";
            
            leftContainer.appendChild(title);
            leftContainer.appendChild(statusSpan);

            let btnGroup = document.createElement('div');
            
            let toggleBtn = document.createElement('button');
            toggleBtn.className = "btn btn-sm btn-outline-secondary me-2";
            toggleBtn.innerHTML = "Edit Metadata";
            toggleBtn.type = "button";
            
            let deleteBtn = document.createElement('button');
            deleteBtn.className = "btn btn-sm btn-outline-danger";
            deleteBtn.innerHTML = "Delete";
            deleteBtn.type = "button";

            btnGroup.appendChild(toggleBtn);
            btnGroup.appendChild(deleteBtn);

            header.appendChild(leftContainer);
            header.appendChild(btnGroup);

            let metaForm = document.createElement('div');
            metaForm.style.display = "none";
            metaForm.className = "mt-2 pt-2 border-top";
            
            metaForm.innerHTML = `
                <input type="hidden" name="food_models-${formUniqueId}-filename" value="${filename}">
                
                <div class="mb-2">
                    <label class="form-label small">Title</label>
                    <input type="text" class="form-control form-control-sm" name="food_models-${formUniqueId}-title">
                </div>
                <div class="mb-2">
                    <label class="form-label small">Description</label>
                    <textarea class="form-control form-control-sm" rows="2" name="food_models-${formUniqueId}-description"></textarea>
                </div>
                <div class="mb-2">
                    <label class="form-label small">Tags</label>
                    <input type="text" class="form-control form-control-sm" name="food_models-${formUniqueId}-tags">
                </div>
                
                <div class="mb-2">
                    <label class="form-label small">Authors</label>
                    <div id="food_models-${formUniqueId}-authors_container"></div>
                    <button type="button" class="btn btn-sm btn-secondary add_author_to_file"
                            data-container="food_models-${formUniqueId}-authors_container"
                            data-prefix="food_models-${formUniqueId}-">
                        Add Author
                    </button>
                </div>
            `;

            toggleBtn.addEventListener('click', () => {
                metaForm.style.display = metaForm.style.display === "none" ? "block" : "none";
            });

            deleteBtn.addEventListener('click', () => {
                fetch("{{ url_for('fooddataset.delete_file_temp') }}", {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({file: filename})
                });
                listItem.remove();
                if (fileList.children.length === 0) {
                    document.getElementById("upload_dataset").style.display = "none";
                }
            });
            
            listItem.appendChild(header);
            listItem.appendChild(metaForm);
            fileList.appendChild(listItem);

            if (typeof validateTempFile === 'function') {
                validateTempFile(filename, `check_status_${formUniqueId}`);
            }
        }

            /* ---------- Dropzone config  ---------- */

            if (typeof Dropzone !== 'undefined') {
                Dropzone.autoDiscover = false;

                Dropzone.options.myDropzone = {
                    url: "/dataset/file/upload",
                    paramName: 'file',
                    maxFilesize: 10,
                    acceptedFiles: '.food',
                    init: function () {
                        let alerts = document.getElementById('alerts');
                        this.on('addedfile', function (file) {
                            alerts.innerHTML = '';
                            alerts.style.display = 'none';
                        });

                        this.on('success', function (file, response) {
                            console.log("File uploaded via Dropzone: ", response);
                            if (response && response.filename) {
                                addFoodModelElement(response.filename);
                            } else if (response && response.files) {
                                response.files.forEach(fn => addFoodModelElement(fn));
                            } else {
                                addFoodModelElement(file.name);
                            }
                        });

                        this.on('error', function (file, response) {
                            console.error("Error uploading file: ", response);
                            let alert = document.createElement('p');
                            alert.textContent = 'Food not valid: ' + file.name;
                            alerts.appendChild(alert);
                            alerts.style.display = 'block';
                        });
                    }
                };

                document.addEventListener('DOMContentLoaded', function () {
                    let dzEl = document.getElementById('myDropzone');
                    if (dzEl && !dzEl.dropzone) {
                        new Dropzone(dzEl, Dropzone.options.myDropzone);
                    }
                });
            }

            /* ---------- GitHub import ---------- */

            document.getElementById("import_repo_btn").addEventListener("click", function (e) {
                e.preventDefault();
                const urlInput = document.getElementById("gh_url").value.trim();
                let branch = document.getElementById("gh_branch").value.trim() || 'main';
                const status = document.getElementById("gh_status");
                
                // Clear previous search results
                const fileListGh = document.getElementById("file-list-gh");
                if (fileListGh) {
                    fileListGh.innerHTML = "";
                }
                
                status.style.display = "block";
                status.innerHTML = "Analyzing repo...";

                const m = urlInput.match(/github\.com\/([^\/]+)\/([^\/]+)(?:\/|$)/i);
                if (!m) {
                    status.innerHTML = "<span class='text-danger'>Invalid GitHub URL</span>";
                    return;
                }
                const owner = m[1];
                const repo = m[2];

                // Usar API Git trees para listar ficheros (recursivo)
                const treesUrl = `https://api.github.com/repos/${owner}/${repo}/git/trees/${encodeURIComponent(branch)}?recursive=1`;

                fetch(treesUrl)
                .then(r => {
                    if (!r.ok) throw new Error("GitHub repository or Branch not found");
                    return r.json();
                })
                .then(data => {
                    if (!data.tree) throw new Error("Unexpected response from GitHub API");
                    const FoodFiles = data.tree.filter(item => item.type === 'blob' && (item.path.endsWith('.food')));
                    if (FoodFiles.length === 0) {
                        status.innerHTML = "<span class='text-warning'>No .food files found in the repository</span>";
                        return;
                    }
                    status.innerHTML = `Found ${FoodFiles.length} files. Downloading and uploading...`;

                    let uploaded = 0;
                    FoodFiles.forEach(item => {
                        const rawUrl = `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${item.path}`;
                        fetch(rawUrl)
                        .then(r => {
                            if (!r.ok) throw new Error("Could not be download: " + item.path);
                            return r.blob();
                        })
                        .then(blob => {
                            const file = new File([blob], item.path.split('/').pop(), { type: 'application/octet-stream' });
                            const form = new FormData();
                            form.append('file', file);

                            return fetch('/dataset/file/upload', {
                                method: 'POST',
                                body: form
                            });
                        })
                        .then(r => {
                            if (!r.ok) return r.text().then(t => { throw new Error(t || ('Server error ' + r.status)); });
                            const ct = r.headers.get('content-type') || '';
                            if (ct.indexOf('application/json') === -1) return r.text().then(t => { throw new Error(t || 'Invalid JSON response'); });
                            return r.json();
                        })
                        .then(resp => {
                            if (resp && resp.filename) {
                                addFoodModelElement(resp.filename);
                            } else {
                                addFoodModelElement(item.path.split('/').pop());
                            }
                            uploaded++;
                            status.innerHTML = `${uploaded}/${FoodFiles.length} uploaded`;
                        })
                        .catch(err => {
                            console.error('Error procesando', item.path, err);
                            status.innerHTML = "<span class='text-danger'>Error uploading " + item.path + ": " + err.message + "</span>";
                        });
                    });
                })
                .catch(err => {
                    console.error(err);
                    status.innerHTML = "<span class='text-danger'>Error importing repository: " + err.message + "</span>";
                });
            });


            /* ---------- ZIP import ---------- */
            // Helper to dynamically load a script and return a Promise that resolves when loaded
            function loadScript(url) {
                return new Promise(function (resolve, reject) {
                    const s = document.createElement('script');
                    s.src = url;
                    s.async = true;
                    s.onload = () => resolve();
                    s.onerror = (e) => reject(new Error('Failed to load script ' + url));
                    document.head.appendChild(s);
                });
            }

            document.getElementById("upload_zip_btn").addEventListener("click", function (e) {
                e.preventDefault();
                const input = document.getElementById("zip_input");
                const status = document.getElementById("zip_status");
                if (!input.files || !input.files[0]) {
                    status.style.display = "block";
                    status.innerHTML = "<span class='text-danger'>Please select a ZIP file first</span>";
                    return;
                }

                const proceed = function() {
                    const zipFile = input.files[0];
                    status.style.display = "block";
                    status.innerHTML = "Please select a ZIP file first";

                    const jszip = new JSZip();
                    jszip.loadAsync(zipFile).then(zip => {
                        const FoodEntries = [];
                        zip.forEach((relativePath, zipEntry) => {
                            if (!zipEntry.dir && (relativePath.endsWith('.food'))) {
                                FoodEntries.push(zipEntry);
                            }
                        });

                        if (FoodEntries.length === 0) {
                            status.innerHTML = "<span class='text-warning'>No .food files found in the ZIP</span>";
                            return;
                        }

                        status.innerHTML = `Found ${FoodEntries.length} files. Uploading...`;
                        let uploaded = 0;

                        FoodEntries.forEach(entry => {
                            entry.async('blob').then(blob => {
                                const fileName = entry.name.split('/').pop();
                                const file = new File([blob], fileName, { type: 'application/octet-stream' });
                                const form = new FormData();
                                form.append('file', file);

                                    return fetch('/dataset/file/upload', {
                                        method: 'POST',
                                        body: form
                                    });
                                })
                                .then(r => {
                                    if (!r.ok) return r.text().then(t => { throw new Error(t || ('Server error ' + r.status)); });
                                    const ct = r.headers.get('content-type') || '';
                                    if (ct.indexOf('application/json') === -1) return r.text().then(t => { throw new Error(t || 'Invalid JSON response'); });
                                    return r.json();
                                })
                                .then(resp => {
                                    if (resp && resp.filename) {
                                        addFoodModelElement(resp.filename);
                                    } else {
                                        addFoodModelElement(entry.name.split('/').pop());
                                    }
                                    uploaded++;
                                    status.innerHTML = `${uploaded}/${FoodEntries.length} uploaded`;
                                })
                                .catch(err => {
                                    console.error('Error subiendo entry', entry.name, err);
                                    status.innerHTML = "<span class='text-danger'>Error subiendo " + entry.name + ": " + err.message + "</span>";
                                });
                        });
                    }).catch(err => {
                        console.error('Error leyendo ZIP', err);
                        status.innerHTML = "<span class='text-danger'>Error leyendo ZIP: " + err.message + "</span>";
                    });
                };

                // Ensure JSZip is available; if not, load it dynamically
                if (typeof JSZip === 'undefined') {
                    loadScript('https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js')
                        .then(() => proceed())
                        .catch(err => {
                            console.error('Error cargando JSZip', err);
                            status.style.display = 'block';
                            status.innerHTML = "<span class='text-danger'>JSZip library could not be loaded</span>";
                        });
                } else {
                    proceed();
                }
            });

    </script>

    <script>
        Dropzone.options.myDropzone = {
            url: "{{ url_for('fooddataset.upload_file_temp') }}",
            paramName: 'file',
            maxFilesize: 10,
            acceptedFiles: '.food',
            init: function () {
                let fileList = document.getElementById('file-list');
                let alerts = document.getElementById('alerts');

                this.on('success', function (file, response) {
                    show_upload_dataset(); 

                    let formUniqueId = generateIncrementalId(); 

                    let listItem = document.createElement('li');
                    listItem.className = "mb-3 p-3 border rounded bg-light";
                    
                    let header = document.createElement('div');
                    header.className = "d-flex justify-content-between align-items-center mb-2";
                    
                    let leftContainer = document.createElement('div');
                    leftContainer.className = "d-flex align-items-center";
                    
                    let title = document.createElement('strong');
                    title.textContent = response.filename;
                    
                    let statusSpan = document.createElement('span');
                    statusSpan.id = `check_status_${formUniqueId}`;
                    statusSpan.className = "ms-3";
                    
                    leftContainer.appendChild(title);
                    leftContainer.appendChild(statusSpan);

                    let btnGroup = document.createElement('div');
                    
                    let toggleBtn = document.createElement('button');
                    toggleBtn.className = "btn btn-sm btn-outline-secondary me-2";
                    toggleBtn.innerHTML = "Edit Metadata";
                    toggleBtn.type = "button";
                    
                    let deleteBtn = document.createElement('button');
                    deleteBtn.className = "btn btn-sm btn-outline-danger";
                    deleteBtn.innerHTML = "Delete";
                    deleteBtn.type = "button";

                    btnGroup.appendChild(toggleBtn);
                    btnGroup.appendChild(deleteBtn);

                    header.appendChild(leftContainer);
                    header.appendChild(btnGroup);

                    let metaForm = document.createElement('div');
                    metaForm.style.display = "none";
                    metaForm.className = "mt-2 pt-2 border-top";
                    
                    metaForm.innerHTML = `
                        <input type="hidden" name="food_models-${formUniqueId}-filename" value="${response.filename}">
                        
                        <div class="mb-2">
                            <label class="form-label small">Title</label>
                            <input type="text" class="form-control form-control-sm" name="food_models-${formUniqueId}-title">
                        </div>
                        <div class="mb-2">
                            <label class="form-label small">Description</label>
                            <textarea class="form-control form-control-sm" rows="2" name="food_models-${formUniqueId}-description"></textarea>
                        </div>
                        <div class="mb-2">
                            <label class="form-label small">Tags</label>
                            <input type="text" class="form-control form-control-sm" name="food_models-${formUniqueId}-tags">
                        </div>
                        
                        <div class="mb-2">
                            <label class="form-label small">Authors</label>
                            <div id="food_models-${formUniqueId}-authors_container"></div>
                            <button type="button" class="btn btn-sm btn-secondary add_author_to_file"
                                    data-container="food_models-${formUniqueId}-authors_container"
                                    data-prefix="food_models-${formUniqueId}-">
                                Add Author
                            </button>
                        </div>
                    `;

                    toggleBtn.addEventListener('click', () => {
                        metaForm.style.display = metaForm.style.display === "none" ? "block" : "none";
                    });

                    deleteBtn.addEventListener('click', () => {
                        fetch("{{ url_for('fooddataset.delete_file_temp') }}", {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({file: response.filename})
                        });
                        listItem.remove();
                        this.removeFile(file);
                        if (this.files.length === 0) {
                            document.getElementById("upload_dataset").style.display = "none";
                        }
                    });
                    
                    listItem.appendChild(header);
                    listItem.appendChild(metaForm);
                    fileList.appendChild(listItem);

                    if (typeof validateTempFile === 'function') {
                        validateTempFile(response.filename, `check_status_${formUniqueId}`);
                    }
                });

                this.on('error', function (file, response) {
                    let p = document.createElement('p');
                    p.textContent = "Error: " + (response.message || file.name);
                    alerts.appendChild(p);
                    alerts.style.display = 'block';
                });
            }
        };

        document.getElementById('agreeCheckbox').addEventListener('change', function() {
            document.getElementById('upload_button').disabled = !this.checked;
        });

        document.getElementById('save_as_draft_button').addEventListener('click', function () {
            const formData = new FormData();

            const form = document.querySelector('#basic_info_form form') || document.querySelector('#basic_info_form');
            if (form) {
                const inputs = form.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    if (input.name && !input.disabled) {
                        formData.append(input.name, input.value);
                    }
                });
            }
            fetch("/dataset/save_as_draft", {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    window.location.href = "/dataset/list";
                } else {
                    alert("⚠️ Something went wrong: " + JSON.stringify(data));
                }
            })
            .catch(error => {
                console.error("Error saving draft:", error);
                alert("❌ Error saving draft: " + error);
            });
        });
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const importMethodInput = document.getElementById("import_method");

            document.getElementById("local-tab").addEventListener("shown.bs.tab", () => {
                importMethodInput.value = "manual";
            });

            document.getElementById("github-tab").addEventListener("shown.bs.tab", () => {
                importMethodInput.value = "github";
            });

            document.getElementById("zip-tab").addEventListener("shown.bs.tab", () => {
                importMethodInput.value = "zip";
            });
        });
    </script>

{% endblock %}

{% block scripts %}
    <script src="{{ url_for('fooddataset.scripts') }}"></script>
{% endblock %}
