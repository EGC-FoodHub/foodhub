{% extends "base_template.html" %}

{% block title %}View dataset{% endblock %}

{% block head_extra %}
<style>
    .option-button {
        display: block;
        width: 100%;
        margin-bottom: 5px;
    }
    .option-button:last-child {
        margin-bottom: 0;
    }
</style>
{% endblock %}

{% block content %}

<div class="row mb-3">
    <div class="col-6">
        <a href="{{ url_for('public.index') }}" class="btn btn-primary btn-sm" id="search" style="border-radius: 5px;">
            <i data-feather="search" class="center-button-icon"></i>
            Explore more datasets
        </a>
    </div>
</div>

<div class="row">

    <div class="col-xl-8 col-lg-12 col-md-12 col-sm-12">

        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between">
                    <h1><b>{{ dataset.ds_meta_data.title }}</b></h1>
                    <div>
                        <span class="badge bg-secondary">{{ dataset.ds_meta_data.publication_type.name.replace('_', ' ').title() }}</span>
                    </div>
                </div>
                <p class="text-secondary">{{ dataset.created_at.strftime('%B %d, %Y at %I:%M %p') }}</p>

                <div class="row mb-4">
                    <div class="col-md-4 col-12">
                        <span class="text-secondary">Description</span>
                    </div>
                    <div class="col-md-8 col-12">
                        <p class="card-text">{{ dataset.ds_meta_data.description }}</p>
                    </div>
                </div>

                <div class="row mb-2">
                    <div class="col-md-4 col-12">
                        <span class="text-secondary">Uploaded by</span>
                    </div>
                    <div class="col-md-8 col-12">
                        <a href="{{ url_for('profile.user_profile', user_id=dataset.user.id) }}">{{ dataset.user.profile.surname }}, {{ dataset.user.profile.name }}</a>
                    </div>
                </div>

                <div class="row mb-2">
                    <div class="col-md-4 col-12">
                        <span class="text-secondary">Authors</span>
                    </div>
                    <div class="col-md-8 col-12">
                        {% for author in dataset.ds_meta_data.authors %}
                        <p class="p-0 m-0">
                            {{ author.name }}
                            {% if author.affiliation %} ({{ author.affiliation }}) {% endif %}
                            {% if author.orcid %} ({{ author.orcid }}) {% endif %}
                        </p>
                        {% endfor %}
                    </div>
                </div>

                {% if dataset.ds_meta_data.publication_doi %}
                <div class="row mb-2">
                    <div class="col-md-4 col-12">
                        <span class="text-secondary">Publication DOI</span>
                    </div>
                    <div class="col-md-8 col-12">
                        {% if dataset.ds_meta_data.publication_doi.startswith('https://') %}
                            <a href="{{ dataset.ds_meta_data.publication_doi }}" target="_blank">
                                {{ dataset.ds_meta_data.publication_doi }}
                            </a>
                        {% else %}
                            <a href="{{ domain }}/doi/{{ dataset.ds_meta_data.publication_doi }}" target="_blank">
                                {{ dataset.ds_meta_data.publication_doi }}
                            </a>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                {% if dataset.ds_meta_data.dataset_doi %}
                <div class="row mb-2">
                    <div class="col-md-4 col-12">
                        <span class="text-secondary">Fakenodo record</span>
                    </div>
<!--                    <div class="col-md-8 col-12">
                        {% if FLASK_ENV == 'production' %}
                            <a href="https://zenodo.org/doi/{{ dataset.ds_meta_data.dataset_doi }}" target="_blank">
                                https://zenodo.org/doi/{{ dataset.ds_meta_data.dataset_doi }}
                            </a>
                        {% else %}
                            <a href="https://sandbox.zenodo.org/doi/{{ dataset.ds_meta_data.dataset_doi }}" target="_blank">
                                https://sandbox.zenodo.org/doi/{{ dataset.ds_meta_data.dataset_doi }}
                            </a>
                        {% endif %}-->
                    </div>
                </div>
                {% endif %}

                <div class="row mb-2">
                    <div class="col-md-4 col-12">
                        <span class="text-secondary">Tags</span>
                    </div>
                    <div class="col-md-8 col-12">
                        {% if dataset.ds_meta_data.tags %}
                            {% for tag in dataset.ds_meta_data.tags.split(',') %}
                                <span class="badge bg-secondary">{{ tag.strip() }}</span>
                            {% endfor %}
                        {% else %}
                            <span class="text-muted">No tags</span>
                        {% endif %}
                    </div>
                </div>

                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h3>Related Datasets</h3>
                            {% if related_datasets %}
                                <div class="row">
                                    {% for ds in related_datasets %}
                                        <div class="col-md-12 mb-2">
                                            <a href="{{ url_for('basedataset.subdomain_index', doi=ds.ds_meta_data.dataset_doi) }}">
                                                {{ ds.ds_meta_data.title }}
                                            </a>
                                            <br>
                                            <small class="text-muted">
                                                Uploaded on {{ ds.created_at.strftime('%B %d, %Y') }} |

                                                {{ ds.get_cleaned_publication_type() }}
                                            </small>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-secondary">No related datasets found.</p>
                            {% endif %}
                        </div>

                    </div>

            </div>

            {% if dataset.ds_meta_data.dataset_doi %}
            <div class="card-body pt-0">
                <div id="dataset_doi_foodhub" style="display: none">
                    {{ request.host_url }}doi/{{ dataset.ds_meta_data.dataset_doi }}
                </div>
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="copyText('dataset_doi_foodhub')">
                    <i data-feather="clipboard" class="me-1"></i>
                    <b>Copy DOI:</b> {{ dataset.ds_meta_data.dataset_doi }}
                </button>
            </div>
            {% endif %}
        </div>

    </div>

    <div class="col-xl-4 col-lg-12 col-md-12 col-sm-12">

        <div class="list-group mb-3">
            <div class="list-group-item bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Food Models</h4>
                    <span class="badge bg-dark">{{ dataset.files|length }}</span>
                </div>
            </div>

            {% for food_model in dataset.files %}
                {% for file in food_model.files %}
                    <div class="list-group-item">
                        <div class="row align-items-center">
                            <div class="col-12 mb-2">
                                <i data-feather="file-text" class="text-primary"></i> 
                                <strong>{{ file.name }}</strong>
                                <br>
                                <small class="text-muted">
                                    {{ (file.size / 1024)|round(1) }} KB
                                </small>
                            </div>
                            
                            <div class="col-12 text-end">
                                <button onclick="viewFile('{{ file.id }}')" class="btn btn-outline-secondary btn-sm" style="border-radius: 5px;">
                                    <i data-feather="eye"></i> View
                                </button>

                                <a href="{{ url_for('hubfile.download_file', file_id=file.id) }}" 
                                   class="btn btn-primary btn-sm dataset-download-link"
                                   data-dataset-id="{{ dataset.id }}"
                                   style="border-radius: 5px;">
                                    <i data-feather="download"></i> Download
                                </a>

                                <button onclick="checkFile('{{ file.id }}')" class="btn btn-outline-success btn-sm ms-1" style="border-radius: 5px;" title="Check Data">
                                    <i data-feather="clipboard"></i>
                                </button>
                                
                                </div>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="list-group-item text-center text-muted">
                    No models found.
                </div>
            {% endfor %}
        </div>

        <a href="{{ url_for('basedataset.download_dataset', dataset_id=dataset.id) }}" 
           class="btn btn-primary w-100 dataset-download-link"
           data-dataset-id="{{ dataset.id }}"
           style="border-radius: 5px;">
            <i data-feather="download" class="me-1"></i> Download All (.zip)
        </a>

        <button onclick="checkDataset('{{ dataset.id }}')" class="btn btn-warning w-100 mt-2 text-dark" style="border-radius: 5px;">
            <i data-feather="activity" class="me-1"></i> Check Nutrition
        </button>

    </div>

</div>

<div class="modal fade" id="fileViewerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">File Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body bg-light">
                <pre id="fileContent" class="p-3 border rounded bg-white" style="white-space: pre-wrap;"></pre>
            </div>
            <div class="modal-footer">
                <button onclick="copyToClipboard()" class="btn btn-outline-secondary btn-sm">
                    <i data-feather="copy"></i> Copy
                </button>
                <a href="#" id="downloadButton" class="btn btn-primary btn-sm">
                    <i data-feather="download"></i> Download
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        if (typeof feather !== 'undefined') {
            feather.replace();
        }
    });

    function viewFile(fileId) {
        fetch(`/hubfile/view/${fileId}`) 
            .then(response => response.json())
            .then(data => {
                document.getElementById('fileContent').textContent = data.content;
                document.getElementById('downloadButton').href = `/hubfile/download/${fileId}`;
                var modal = new bootstrap.Modal(document.getElementById('fileViewerModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error:', error);
                alert("Error loading file content");
            });
    }

    function copyText(elementId) {
        const text = document.getElementById(elementId).innerText.trim();
        navigator.clipboard.writeText(text).then(() => alert("Copied!"));
    }

    function copyToClipboard() {
        const text = document.getElementById('fileContent').textContent;
        navigator.clipboard.writeText(text).then(() => alert("Content copied!"));
    }
</script>

<div class="modal fade" id="checkerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Food Checker Result</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light">
                <div id="checkerContent"></div>
            </div>
        </div>
    </div>
</div>

<script>
    function checkFile(fileId) {
        fetch(`/api/food_checker/check/file/${fileId}`)
            .then(res => res.json())
            .then(renderCheckerResult)
            .catch(err => alert("Error checking file"));
    }

    function checkDataset(datasetId) {
        fetch(`/api/food_checker/check/dataset/${datasetId}`)
            .then(res => res.json())
            .then(data => {
                let html = `<h4>Total Calories: <b>${data.total_calories} kcal</b></h4>`;
                html += `<p>Valid Files: ${data.valid_files} / ${data.total_files}</p><hr>`;
                data.details.forEach(f => {
                    console.log(f);
                    let color = f.valid ? 'success' : 'danger';
                    html += `<div class="mb-2 p-2 border-start border-4 border-${color} bg-white">
                                <strong>${f.filename}</strong>: ${f.valid ? (f.data.calories || 'No kcal info') : 'Invalid file'}
                             </div>`;
                });
                showModal(html);
            });
    }

    function renderCheckerResult(data) {
        if (!data.valid) {
            showModal(`<div class="alert alert-danger">Invalid file</div>`);
            return;
        }
        let d = data.data;
        let html = `<div class="card p-3">
                        <h3>${d.name} <span class="badge bg-success float-end">${d.type}</span></h3>
                        <h5 class="text-muted">${d.calories}</h5>
                        <hr>
                        <h6>Nutritional Values:</h6>
                        <ul>`;
        
        if (d.nutritional_values) {
            for (const [key, val] of Object.entries(d.nutritional_values)) {
                html += `<li><b>${key}:</b> ${val}</li>`;
            }
        }
        html += `</ul></div>`;
        showModal(html);
    }

    function showModal(htmlContent) {
        document.getElementById('checkerContent').innerHTML = htmlContent;
        new bootstrap.Modal(document.getElementById('checkerModal')).show();
    }
</script>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('public.scripts') }}"></script>
{% endblock %}